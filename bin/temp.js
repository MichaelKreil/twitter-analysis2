"use strict"

const fs = require('fs');
const colors = require('colors');
const scraper = (require('../lib/scraper.js'))();

var task1 = scraper.getSubTask();
var ids = '760181918180773888,760524399376232448,760550966231904256,760722156636471296,760722675392217088,760723901865394177,760725895405535233,761020316101414912,761210626639265792,761263335228710912,761328359687196672,761399624246722561,761561338254659584,761561483293720576,761564350733778944,761599194272497664,761599544022958081,761674195357007872,762107859203162112,762970404063412228,762971150498619392,763197092693245952,763197171021803520,763197533564854277,763198000487424005,763198341652045824,763199218702028800,763201623971729408,763202313259454465,763203876463972352,763336895132790789,763339469399420928,763484289489113088,763536844491456512,763550488071704576,763551686027771904,763556704462184448,763557226867023873,763557341748928514,763557527376232448,763558000950910976,763679757875765248,763680426993053696,763682393521790976,763682656357933057,763683080347521024,763683268633956352,763683728623271936,763683898643640320,763684564506116097,763685050672095232,763685309448069120,763685546153705472,763685798273249280,763685952288092161,763686417503555584,763686992060227584,763687269182169088,763687631058268160,763688359306924032,763688714379882496,763688799729754112,763689831360786432,763690095673274369,763690517611806720,763690811896766464,763690943522406400,763691145717288960,763693005207433216,763693264109236224,763693391624437761,763796842710794241,763839344461418496,763854454449967104,763854956004802560,763856697035202560,764041980846411776,764059830138998784,764060277901893633,764060573126434820,764079748989321216,764080140938641409,764080305607020544,764080528861507585,764080946475782144,764081071277289472,764081202823176193,764081480146362369,764081735537528833,764082176413437952,764082492819202048,764083029690028032,764083414475563008,764084805709422594,764085121162944512,764085410679042048,764086814915301376,764088293814263808,764091260453855237,764092505600106497,764093366774542338,764293215646277632,764413572189421569,764413835872768000,764414849174630400,764415908169314304,764416191964282880,764422730590617600,764422827323846656,764423729254465536,764423833113722880,764469898953228288,764471359435145216,764648498092511232,764947544740945924,764948599860002817,764948809294241794,765890211066834944,765891062317584384,765891525146513408,765892072134049792,766010869734117376,766047869660954624,766048367101313024,766050061558116352,766050515503443968,766061192989245440,766070388338089984,766074049478922241,766317106178748416,766472175687725060,766473067363270656,766473355683848192,766473942425079808,766474994364866560,766475175411974144,766475436264226816,766626679854948352,766786432077799424,766827811969634304,766828146196934657,766828450959220737,766828893181468672,766828982008512512,766829179690225665,766829821045403648,767679311826526209,767679356466520064,767713741295198208,767728439830913024,767919973914275840,768412797692735488,768412997568065536,768522301914492930,768536596819824640,768536708094636032,768537260320960512,769197317182357504,769955975037984768,770110446074531840,771084688358248452,771086776203182081,771087490795143168,771088954984636416,771089285764280320,771089385265725440,771091175763738624,771156674325409792,771157029616553984,771157328414531584,771160258492465153,771161947253473280,771162170595901441,771162397130326016,771162933879508992,771163268375339012,771163551411109888,771163986935083008,771164280859361280,771164605590736900,771164864429645830,771165190591287296,771165449409167360,771165776908808192,771166544885911552,771166736091582464,771167334375514112,771167502948769792,771167749162885120,771167921653637120,771168283798175744,771168591110602752,771169132565889024,771169547974049792,771171332272906240,771171499185147904,771171786964758528,771172332949893120,771172931116339200,771173131620904960,771173504217735168,771173723608981504,771315538387689472,771315807766908928,771316532320342016,771317178494844928,771317917497626626,771318422588231680,771318571456688128,771319028644245504,771319775402266624,771320902977982464,771321204363894784,771321321187868672,771321751955501056,771322225270161408,771322488068382720,771322835855892480,771322981515665408,771332936507555840,771333636977295360,771369661304799232,771376707613945856,771854761117249536,771856464977747968,771857813165469696,772227395524976644,772231154703470592,772231635546800128,772231708955533313,772236783417450496,772266051254030336,772277658327605248,772277854591647744,772278362723278848,772278477802405888,772279480517857280,772296217854222336,772417277757100032,772417580657246208,772418078638542848,772418369115025409,772418612787351552,772419167374942209,772538701444419586,772538938426814464,772552524104667136,772878501548392448,772879170439417856,773134169975160832,773134777784406016,773450490193518594,773451230471450625,773453851089334272,773453979770621952,773454188764430336,773454768563974145,773455314620473349,773455380466761728,773456452757417985,773457153478815745,773457399906787329,773457921732640768,773458221738721282,773458517428674560,773460014304522241,773460244081049600,773475592096325632,773649278212435968,773650205082255364,773676809896460289,773713022011465728,773716631180697600,773716940544180224,773717292077244428,774616456596168704,774618262839631872,774619719664099329,774620128394747904,774620529714139138,774620732471046146,774620830986801153,774621146553737218,774621522082275329,774621756422254592,774622109041561600,774622438999126017,774622840008085504,774622945025069056,774623283648008192,774623792203173888,774624395851624448,774624559123275776,774624911650332672,774625008110997504,774625152646733825,774625842496438277,774626392352886786,774626824236175360,774627269004451841,774627434834567169,774627617865596928,774628520588898305,774628703036997633,774628946872795136,774629117815840768,774629397286584320,774629484972695552,774630360864915456,774630728663465985,774949849108246534,775471710560776192,775472534108200963,775472691046408192,775474757273784321,775475163659993088,775475625679257600,775476172520038400,775476312840478720,775477753776902144,775481319388278785,775976299517120513,777045061230034944,777368849985536001,777369814746693632,777370768950853632,777371067899863040,777371408246697984,777371637536743424,777374512153264128,777374906824658944,777375318659198978,777375709304152064,777376252386762752,777377102442196992,777377643427758081,777377972185600000,777378503075463168,777379034061766656,777381113371168768,777381982888222720,778577475332927488,778689288007393282,778697397358563329,778698144297029632,778699152922292224,778783090105786368,778893516646776832,779405507513688064,779715384664612864,779752101920604162,780168430175617024,780215652762132480,780224355162816513,780448713516912640,780543157037588481,780605066457808896,780748499705008128,781045767771451392,781046721015083008,781053566614200320,781054443190161408,781688171750907905,781811326347776000,781907601361625088,781908230259769344,781986865037672448,783491973638397952,783509921316872192,786203104534523905,786203966141063169,786205038788091904,786336250181611520,786861257697685504,787222404120666114,787223682460557312,787224709985406976,787224948930510848,787225750210576384,787226086690160640,787226822006173696,787227854702538753,787228618393083904,787229043720646660,787230095052247040,787232942380740608,787234556042698752,787234937825062912,787236351141904384,787239566826766336,787241280447315968,787241998998732800,787243523678625792,787243682374250496,787244183165763585,787244500708106240,787245647867080704,787246644144340992,787247131413405697,787249254196715520,787250091954438148,787267270162673664,787267482616795136,787267995844378625,787269532834471936,787270444453863424,787272471422627840,787272884167270405,787362399489851393,787366718884708352,787367083940147200,787605743725871104,787641710742560768,787727579558113280,788398258070679553,788495813534162946,788496233119813632,788496914652233730,788497045766242304,788497132579852288,788497439309307904,788497700757069824,788497859729584128,788498060749971457,788498301268201472,788510534824067072,788510761010298881,788511219439243264,788511532883800064,788698718916730881,788699105228914690,788699368727674880,788945952358993920,788946605990895616,788950064257462272,788952272931872768,788952655271981057,788953055282733056,788953392257331200,788953839252676608,788954731234332672,789237662108508160,789399597969838081,789399869584650240,789400266684510208,789400897658822657,789401333128323072,789402000777555968,789403200960868352,789405233558409216,789405388252647425,789405956647956480,789886941596618752,789889130054451200,789889542417485824,790874130946134016,790875122831859712,790876125614465024,791099126888992768,791100444093386752,791100558547509249,791100781646737408,791102991956860929,791106144643211265,791232250922893312,791237202080567296,791237663558885376,791238866099404801,791239544108617728,791240073668886529,791240326967099392,792129359905775618,792130832408408064,792132206437232640,792132755672879104,792133009935826944,792133550413840384,792133756500975616,792133869822681088,792134796415737857,792134995452108800,792135170522484736,792135351842267141,792135546344710149,792135962994311168,792136083995783168,792136257652613120,792140119092367360,792141833866448898,792183975192174592,792184554379472896,792192702792302592,792194036346003456,792195596929105920,792195805025300480,792198098252656641,792198719059980288,792198849125376000,792198995925934080,792199318950318080,792199602132910080,792200717712908288,792201811121868800,792203437089906688,792203935218069504,792204102306529280,792204439528599552,792206476106461184,792206769258913792,792207053087465473,792207247262777344,792208240822063104,792208857787424768,792209345933152256,792209759822868480,792209978232832000,792210250011213824,792210361835462656,792312747262377984,792312973868015616,792313154969673728,792313719162298368,792314161522958337,792314988912340992,792319092824875008,792319276707418112,792319467007213568,792319593222135808,792322519495806976,792323263603019777,792324401714831360,792324919384309760,792326546254077953,792326783265828864,792327159348158469,792328124063252480,792329479855243264,792330496281829376,792330912587452416,792331398367551490,792332764183982080,792333867172716544,792338740052189184,792339277954842627,792339938578665472,792340189788209152,792340971690291200,792341287869480961,792350587862089728,792350676953272320,792351620340281345,792373531002757120,792373982884397056,792374274468220928,792383574729166848,792386732452933632,792388214778626049,792389716406665216,792390004286849024,792390144045244417,792391280982720512,792391686496227328,792474780830146560,792475661193674754,792476801138249728,792478021072584704,792478749094768643,792479221935398912,792479610629918720,792479711414853634,792566940548104192,792665824251277312,792715665924886528,792734095243632640,792850282078171137,792851677800005637,793016888238407680,793018084093259776,793018326708518912,793053231958065152,793146674998804480,793413724145086465,793414374522232832,793414937339129857,793415399144562688,793415671199793152,793416841020502016,793417329115815936,793417653650067456,793417924618883072,793418141498019841,793418607715909632,793419027678957568,793419175721074688,793419561978716160,793451941670035456,793475604649836544,793579480598081536,793579607131815937,793579845724827650,793580102546296832,793616069361541120,793747893031165952,793766534552453120,793852321746804736,793852711850635264,793924414760947714,793927142262407168,793927867524669440,793928147540541440,793928348271513600,793928578681409536,793929372667445257,793929666889388033,793930593130135553,793931175312101376,793931551486705665,793933325001965570,793933793296084992,794002489846726656,794004020562104321,794007100439592960,794008110654484481,794008416146653184,794008859274805248,794009315506028545,794010266220556288,794011622494916609,794014526987444224,794015905315438592,794018119635312640,794139282105634817,794229539287273472,794381028760702979,794391565884157952,794464842849681408,794504172724961280,794505469566001152,794505837960187905,794506177233227776,794506586706296832,794506761533329408,794507227721764866,794510467351904261,794516813325434880,794633671630262277,794633901260046336,794635657155067904,794635928878858240,794636409395150848,794636877852737536,794637096816439296,794637701622460420,794638124999737345,794639281792937985,794646480145551364,794646559963090944,794718821697331200,794726653297565696,794856622212386818,794912621405282305,794912741874135040,794913943575789568,794914268739207168,794914737012305920,794916131123462144,794916719328395264,795253676147347456,795762691260477444,795764929601081344,795765234447347713,795765317402296321,795765488815140864,795765733246562304,795949463663742978,795950083359571969,795950269070708736,795950421890236416,795950648030351360,795950720759504896,795950903559856128,795951289020641284,795952007848886273,795953911312093184,795981563863371780,796004204393406468,796162167171059713,796162405373984772,796162664368111619,796194287700545536,796215256456564737,796276027991408640,796276214965174272,796672000592842752,796672703369478145,796673240718569472,796673491659530241,796674476289179648,796680076461035520,796704425393975296,796744061768073218,796827321911169024,796828396584058880,796953974742122496,797042964342116352,797044004449906688,797044097424965633,797045001456939008,797045664995770368,797046085659324416,797046380967657472,797046589718196224,797046793406205952,797047135946555392,797047730220699648,797048092524740608,797048990235762688,797049125057527808,797049474275282944,797050188644884480,797050427229487104,797050614782054400,797050721594175488,797051111920336896,797051365587611648,797051799068901376,797052135292760064,797052700722688000,797053029707091968,797053362638389248,797053976336363520,797054306776190976,797054678504787969,797055217120509952,797055509505441792,797055977136721921,797462708362903553,797463418005557248,797463844943708160,797464272330719233,798637555096973312,798649497635033088,798653965562851329,798654382443151363,798654701571047425,798657437876310020,798657893579059200,798658035052847104,798662273460043776,798686252014993408,798757420486955008,798757797932376064,798758046285430784,798758546867265536,798758645722796032,798759089572483072,799092135534465024,799092349032865792,799092729938640897,799094054168514564,799094365813669888,799094570348908544,799095216422715393,799095804082397184,799096374147055616,799096854361337856,799097095672176640,799097442293661696,799097603334008834,799097966460043264,799098420971638789,799098778049544192,799099159630479360,799099595007660032,799099945735323648,799100657827540993,799100922131517440,799101468624228352,799101870509871104,799102179500064768,799102476511301632,799102726772817920,799103195964383232,799103450814578688,799103949685067777,799104673751986176,799105021396865025,799105592560353280,799105709363359744,799105903953899520,799106419094126592,799106556491079689,799247896310755328,799248482729132036,799249137921327104,799289542322884609,800654295930540036,800654795317067776,800655263883755521,800655537587310592,800655900688220161,801882433289236480,802261382066413568,802309707884965888,803545170981613568,803595098306977794,803596760232951808,803598548172320769,803619202783322112,803733889994792960,803742770930323458,803743047745994757,803743245801025536,804266297144049665,804659301109428225,805040178385522688,805042764232716292,805043079677878273,805046478322470912,805047855840948224,805048144224460800,805048608978534400,805049056745680896,805049775557115909,805050356673679361,805050860246024192,805051682321272832,805052314172227592,805052888259108864,805053242501697536,805108586292637696,805108901721079809,805355348789985280,805356078494023681,805357154152681472,805492124301099008,805605043143671808,805922488458874880,805922728842854401,805924577520078849,805925009495572480,806229698632155140,806452809499635712,806689797720903680,806691531465916420,806696234446635008,807954859802640384,808288965635686400,808736188844638208,809254807999496192,811243356466671616,811897039470608384,811898555799638016,811899769245368321,811900968476491776,811901277252816897,811901849217417216,811902118227509248,811902749550018560,811903963306086400,811904642347110404,811904760043474944,811905027984019456,811905237715980288,811905401805504512,811906120851787776,811906301903142912,812126497209274372,812128390409060352,812143551253516289,812245333128384512,812247665010479104,812801422127403013,812802444476448768,814087104569319424,814094488276602880,814177850878148608,814183328471457792,814183668889559040,814183779954610176,814184058917748736,814674562407395330';
ids = ids.split(',');
var result = [];

run();

function run() {
	if (ids.length === 0) return finish();
	var block = ids.slice(0,100);
	ids = ids.slice(100);
	fetch(block, run);
}

function finish() {
	var allKeys = new Map();

	result.sort((a,b) => a.id_str < b.id_str ? -1 : 1);
	
	fs.writeFileSync('tweets.json', JSON.stringify(result), 'utf8');

	result.forEach(t => scanKeys(t, []));

	var entries = Array.from(allKeys.entries());
	entries.sort((a,b) => a[0] < b[0] ? -1 : 1);
	var keyList = entries.map(e => e[0]);
	var valList = entries.map(e => e[1]);
	result = result.map(t => valList.map(v => getObjectValue(t, v)).join('\t'))
	

	result.unshift(keyList.join('\t'));
	fs.writeFileSync('tweets.tsv', result.join('\n'), 'utf8')


	function scanKeys(obj, parentList) {
		Object.keys(obj).forEach(key => {
			var keyList = parentList.slice(0);
			keyList.push(key);
			var value = obj[key];
			if ((value !== null) && (typeof obj[key] === 'object')) {
				scanKeys(obj[key], keyList);
			} else {
				var keyHash = keyList.join('.');
				if (!allKeys.has(keyHash)) allKeys.set(keyHash, keyList);
			}
		})
	}

	function getObjectValue(obj, keyList) {
		for (var i = 0; i < keyList.length; i++) {
			var key = keyList[i];
			obj = obj[key];
			if (obj === undefined) return '-';
			if (obj === null) return 'null';
		}
		//if (obj instanceof Date) return obj.toISOString();
		return JSON.stringify(obj);
	}
}

function fetch(ids, cb) {
	task1.fetch(
		'statuses/lookup',
		{id:ids.join(','), stringify_ids:true},
		data => {
			data.forEach(t => result.push(t));
			cb();
		}
	)
}
